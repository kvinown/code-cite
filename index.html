<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<title>Code Cite</title>
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0" />

		<!-- Tailwind (CDN) - hanya untuk demo/development -->
		<link
			href="./libs/tailwind/tailwind.min.css"
			rel="stylesheet" />

		<!-- Highlight.js -->
		<script src="./libs/dependencies/highlight.min.js"></script>
		<link
			rel="stylesheet"
			href="./libs/dependencies/atom-one-dark.min.css"
			type="text/css"
			title="Atom" />

		<!-- React & ReactDOM -->
		<script src="./libs/react/react.development.js"></script>
		<script src="./libs/react/react-dom.development.js"></script>

		<!-- Lucide Icons (UMD) -->
		<script src="./libs/dependencies/lucide.js"></script>

		<!-- JSZip -->
		<script src="./libs/dependencies/jszip.min.js"></script>
		<script src="./libs/dependencies/FileSaver.min.js"></script>

		<!-- Babel (compile JSX langsung di browser) -->
		<script src="./libs/babel/babel.min.js"></script>

		<link
			rel="stylesheet"
			href="style.css" />

		<!-- CSS BARU untuk Efek Flash -->
		<style>
			@keyframes flash-animation {
				0% {
					background-color: rgba(252, 211, 77, 0); /* yellow-300/0 */
				}
				25% {
					background-color: rgba(252, 211, 77, 0.6); /* yellow-300/60 */
				}
				75% {
					background-color: rgba(252, 211, 77, 0.6); /* yellow-300/60 */
				}
				100% {
					background-color: rgba(252, 211, 77, 0); /* yellow-300/0 */
				}
			}

			.flash-highlight {
				animation: flash-animation 1.5s ease-out;
			}
		</style>
	</head>
	<body class="bg-gray-100">
		<div id="root"></div>

		<!-- App -->
		<script type="text/babel">
			const { useState, useEffect, useRef } = React;
			//==================================================
			// Component: Header
			//==================================================
			window.Header = () =>
				React.createElement(
					"header",
					{ className: "bg-white shadow-sm" },
					React.createElement(
						"div",
						{ className: "max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center" },
						React.createElement(
							"div",
							{ className: "flex items-center" },
							React.createElement(
								"svg",
								{
									className: "w-10 h-10 text-cyan-500",
									viewBox: "0 0 24 24",
									fill: "none",
								},
								React.createElement("path", {
									d: "M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15v-2h2v2h-2zm0-4v-6h2v6h-2z",
									fill: "currentColor",
								})
							),
							React.createElement("span", { className: "ml-3 text-2xl font-bold text-gray-800" }, "Code Cite")
						),
						React.createElement("div", { className: "text-gray-600" }, "Hello John Doe")
					)
				);

			//==================================================
			// Component: Header End
			//==================================================

			//==================================================
			// Component: Navbar
			//==================================================
			window.Navbar = () => {
				const navItems = ["Dashboard", "My Projects", "Account", "About", "Logout"];
				return React.createElement(
					"nav",
					{ className: "bg-cyan-600" },
					React.createElement(
						"div",
						{ className: "max-w-7xl mx-auto px-2 sm:px-6 lg:px-8" },
						React.createElement(
							"div",
							{ className: "relative flex items-center justify-start h-12" },
							React.createElement(
								"div",
								{ className: "flex items-center space-x-4" },
								navItems.map((item) =>
									React.createElement(
										"a",
										{
											key: item,
											href: "#",
											className: "text-white hover:bg-cyan-700 px-3 py-2 rounded-md text-sm font-medium",
										},
										item
									)
								)
							)
						)
					)
				);
			};

			//==================================================
			// Component: Navbar End
			//==================================================

			//==================================================
			// Component: Upload Screen
			//==================================================
			// Komponen Pesan Error
			const ErrorMessage = ({ message, onClear }) => {
				if (!message) return null;
				return React.createElement(
					"div",
					{ className: "mt-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative", role: "alert" },
					React.createElement("span", { className: "block sm:inline" }, message),
					React.createElement(
						"span",
						{ className: "absolute top-0 bottom-0 right-0 px-4 py-3", onClick: onClear },
						React.createElement(
							"svg",
							{ className: "fill-current h-6 w-6 text-red-500", role: "button", xmlns: "http://www.w3.org/2000/svg", viewBox: "0 0 20 20" },
							React.createElement("title", null, "Close"),
							React.createElement("path", {
								d: "M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z",
							})
						)
					)
				);
			};

			window.UploadScreen = ({ onUpload }) => {
				const [file, setFile] = useState(null);
				const [projectName, setProjectName] = useState("");
				const [isDragging, setIsDragging] = useState(false);
				const [isUploading, setIsUploading] = useState(false);
				const [progress, setProgress] = useState(0);
				const [error, setError] = useState("");
				const fileInputRef = useRef(null);

				const handleFileSelect = (selectedFile) => {
					setError("");
					if (selectedFile && selectedFile.name.endsWith(".zip")) {
						setFile(selectedFile);
						if (!projectName) {
							// [REVISI] Coba tebak nama proyek dari nama file zip
							// "proyek-saya-codecite-timestamp.zip" -> "proyek-saya"
							let name = selectedFile.name.replace(/\.zip$/, "");
							name = name.replace(/-codecite-.*$/, ""); // Hapus suffix -codecite
							setProjectName(name);
						}
					} else {
						setError("Hanya mendukung file .zip");
					}
				};

				const handleFileChange = (e) => {
					if (e.target.files.length > 0) {
						handleFileSelect(e.target.files[0]);
					}
				};

				const handleDrop = (e) => {
					e.preventDefault();
					setIsDragging(false);
					if (e.dataTransfer.files.length > 0) {
						handleFileSelect(e.dataTransfer.files[0]);
					}
				};

				const handleDragOver = (e) => {
					e.preventDefault();
					setIsDragging(true);
				};

				const handleDragLeave = () => {
					setIsDragging(false);
				};

				const handleSubmit = () => {
					if (file && projectName) {
						setIsUploading(true);
						setProgress(0);
						const interval = setInterval(() => {
							setProgress((prev) => {
								if (prev >= 100) {
									clearInterval(interval);
									setTimeout(() => {
										setIsUploading(false);
										onUpload(file, projectName);
									}, 500);
									return 100;
								}
								return prev + 10;
							});
						}, 100);
					} else {
						setError("Harap pilih file .zip dan beri nama proyek");
					}
				};

				const UploadIcon = () => React.createElement("i", { "data-lucide": "upload-cloud", className: isDragging ? "text-cyan-500" : "text-gray-400" });

				return React.createElement(
					"div",
					{ className: "bg-white p-8 rounded-lg shadow-lg max-w-2xl mx-auto text-center" },
					React.createElement("h2", { className: "text-2xl font-bold text-gray-800 mb-4" }, "Mulai Proyek Sitasi Baru"),
					React.createElement("p", { className: "text-gray-600 mb-6" }, "Beri nama proyek Anda dan unggah file .zip yang berisi kode sumber."),
					React.createElement(
						"div",
						{ className: "mb-4 text-left" },
						React.createElement("label", { htmlFor: "projectName", className: "block text-sm font-medium text-gray-700 mb-1" }, "Nama Proyek"),
						React.createElement("input", {
							type: "text",
							id: "projectName",
							value: projectName,
							onChange: (e) => setProjectName(e.target.value),
							className: "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-cyan-500 focus:border-cyan-500",
							placeholder: "Contoh: Tugas Akhir Bab 4",
						})
					),
					React.createElement(
						"div",
						{
							className: `border-2 border-dashed rounded-lg p-8 cursor-pointer transition-colors duration-200 flex flex-col items-center justify-center ${
								isDragging ? "border-cyan-500 bg-cyan-50" : "border-gray-300 bg-gray-50 hover:border-cyan-400"
							}`,
							onClick: () => fileInputRef.current.click(),
							onDrop: handleDrop,
							onDragOver: handleDragOver,
							onDragLeave: handleDragLeave,
						},
						React.createElement("input", { type: "file", accept: ".zip", ref: fileInputRef, onChange: handleFileChange, className: "hidden" }),
						React.createElement("div", { className: `mb-3 ${isDragging ? "animate-bounce" : ""}` }, React.createElement(UploadIcon)),
						file
							? React.createElement("p", { className: "text-gray-700" }, "File terpilih: ", React.createElement("span", { className: "font-semibold" }, file.name))
							: React.createElement("p", { className: "text-gray-500" }, "Klik atau drag & drop file ", React.createElement("span", { className: "font-semibold" }, ".zip"), " di sini")
					),
					React.createElement(ErrorMessage, { message: error, onClear: () => setError("") }),
					isUploading &&
						React.createElement(
							"div",
							{ className: "mt-6 w-full bg-gray-200 rounded-full h-3 overflow-hidden" },
							React.createElement("div", {
								className: "bg-cyan-600 h-3",
								style: { width: `${progress}%`, transition: "width 0.3s ease-in-out" },
							})
						),
					React.createElement(
						"button",
						{
							onClick: handleSubmit,
							disabled: !file || !projectName || isUploading,
							className: "mt-6 w-full bg-cyan-600 text-white font-bold py-3 px-4 rounded-md hover:bg-cyan-700 disabled:bg-gray-400 transition-colors",
						},
						isUploading ? "Mengupload..." : "Mulai Proses Sitasi"
					)
				);
			};

			//==================================================
			// Component: Upload Screen End
			//==================================================

			//==================================================
			// Helper: Auto Citation Parsers
			//==================================================

			/**
			 * Mengidentifikasi tipe file berdasarkan nama file.
			 */
			function getFileType(fileName) {
				if (fileName.endsWith(".py")) {
					return "python";
				}
				if (fileName.endsWith(".java")) {
					return "java";
				}
				return null;
			}

			// [BARU] Helper untuk membersihkan baris metadata
			const cleanMetadataLine = (line, commentPrefixRegex) => {
				return line.replace(commentPrefixRegex, "").trim();
			};

			/**
			 * [VERSI BARU - Diambil dari Ekstensi]
			 * Mem-parsing konten kode untuk sitasi otomatis berdasarkan komentar.
			 * Mendukung format Multi-baris (# CODE-CITE:) dan Single-line (#CODE-CITE #...).
			 */
			function parseCitationsFromCode(codeContent, fileType) {
				const newCitations = [];
				if (!codeContent || !fileType) {
					return newCitations;
				}

				const lines = codeContent.split("\n");

				// Definisikan regex berdasarkan tipe file
				let commentPrefix, isCommentRegex, commentPrefixRegex, multiLineStartRegex, singleLineRegex;

				if (fileType === "python") {
					commentPrefix = "#";
					isCommentRegex = /^\s*#/;
					commentPrefixRegex = /^\s*#\s*/;
				} else if (fileType === "java") {
					commentPrefix = "//";
					isCommentRegex = /^\s*\/\//;
					commentPrefixRegex = /^\s*\/\/\s*/;
				} else {
					return newCitations;
				}

				// Regex dinamis
				multiLineStartRegex = new RegExp(`^\\s*${commentPrefix}\\s*CODE-CITE:\\s*$`, "i");
				singleLineRegex = new RegExp(`^\\s*${commentPrefix}\\s*CODE-CITE\\s+(.*)$`, "i");

				const keyValRegex = /^\s*([a-zA-Z\s]+):\s*(.*)$/; // Regex untuk "Key: Value"

				// Loop utama
				for (let i = 0; i < lines.length; i++) {
					const line = lines[i];
					const lineNumber = i + 1; // 1-based index

					const multiLineMatch = line.match(multiLineStartRegex);
					const singleLineMatch = line.match(singleLineRegex);

					// --- Skenario 1: Format Multi-baris (# CODE-CITE:) ---
					if (multiLineMatch) {
						const metadataBlockLines = [];
						const sourceData = { title: "" };
						let linesRange = 1; // Default
						let j = i + 1; // Mulai dari baris setelah # CODE-CITE:

						// 1. Kumpulkan semua baris metadata
						while (j < lines.length && isCommentRegex.test(lines[j])) {
							metadataBlockLines.push(lines[j]);
							j++;
						}
						// 'j' sekarang adalah index dari baris KODE pertama

						// 2. Parse baris metadata
						metadataBlockLines.forEach((rawLine) => {
							const cleanLine = cleanMetadataLine(rawLine, commentPrefixRegex);
							const match = cleanLine.match(keyValRegex);

							if (match) {
								const key = match[1].trim().toLowerCase();
								const value = match[2].trim();

								switch (key) {
									case "title":
										sourceData.title = value;
										break;
									case "type":
										sourceData.type = value.toLowerCase();
										break;
									case "value":
										sourceData.value = value;
										break;
									case "notes":
										sourceData.notes = value;
										break;
									case "lines range":
										linesRange = parseInt(value, 10) || 1;
										break;
								}
							}
						});

						// 3. Validasi
						if (!sourceData.title) {
							console.warn(`CODE-CITE di baris ${lineNumber} tidak memiliki 'Title:'.`);
							i = j - 1; // Lanjutkan loop dari baris kode
							continue;
						}

						// 4. Tentukan baris dan ambil kode
						const startLine = j + 1; // 1-based index
						const endLine = startLine + linesRange - 1;
						if (endLine > lines.length) {
							console.warn(`Lines Range di baris ${lineNumber} melebihi akhir file.`);
							i = j - 1;
							continue;
						}

						const codeBlock = lines.slice(j, j + linesRange).join("\n");

						newCitations.push({
							start: startLine,
							end: endLine, // 'end' adalah inklusif
							code: codeBlock,
							sourceData: sourceData,
						});

						i = j + linesRange - 1; // Lompati baris kode yang sudah disitasi
					}
					// --- Skenario 2: Format Single-line (#CODE-CITE #...) ---
					else if (singleLineMatch) {
						const data = singleLineMatch[1]; // Mendapatkan " #title #type #value #notes #linesRange"
						if (!data) continue;

						// Pisahkan berdasarkan #, buang string kosong (jika ada)
						const parts = data.split("#").map((s) => s.trim()).filter(Boolean);

						if (parts.length === 0) continue; // Tidak ada data

						const sourceData = {
							title: parts[0] || "", // Wajib ada
							type: parts[1],
							value: parts[2],
							notes: parts[3],
						};

						let linesRange = 1;
						if (parts[4]) {
							linesRange = parseInt(parts[4], 10) || 1;
						}

						if (!sourceData.title) {
							console.warn(`CODE-CITE single-line di baris ${lineNumber} tidak memiliki title.`);
							continue;
						}

						// Ambil 'linesRange' baris kode TEPAT DI BAWAHNYA.
						const codeStartIndex = i + 1; // Index baris pertama kode
						const startLine = codeStartIndex + 1; // 1-based index
						const endLine = startLine + linesRange - 1;

						if (endLine > lines.length) {
							console.warn(`Lines Range di baris ${lineNumber} melebihi akhir file.`);
							i++; // Lewati baris ini
							continue;
						}

						const codeBlock = lines.slice(codeStartIndex, codeStartIndex + linesRange).join("\n");

						newCitations.push({
							start: startLine,
							end: endLine, // 'end' adalah inklusif
							code: codeBlock,
							sourceData: sourceData,
						});

						i = codeStartIndex + linesRange - 1; // Lompati baris kode yang sudah disitasi
					}
				} // akhir loop 'for'

				return newCitations;
			}
			//==================================================
			// Helper: Auto Citation Parsers End
			//==================================================

			//==================================================
			// Component: Workspace
			//==================================================
			const COLORS = ["bg-cyan-900/60", "bg-green-900/60", "bg-purple-900/60", "bg-pink-900/60", "bg-yellow-700/60"];

			/**
			 * Helper function untuk mencari file node di dalam tree berdasarkan path.
			 */
			const findFileNodeByPath = (rootChildren, path) => {
				// [REVISI] Path dari JSON mungkin menyertakan nama root,
				// file tree kita tidak. Kita harus tangani ini.
				// e.g., "code_examples/MainApp.java"
				
				// Coba temukan path-nya langsung dulu
				let parts = path.split('/');
				let currentLevel = rootChildren;
				let node = null;
				
				for (let i = 0; i < parts.length; i++) {
					const part = parts[i];
					if (!currentLevel || !currentLevel[part]) {
						node = null; // Path tidak ditemukan
						break;
					}
					node = currentLevel[part];
					currentLevel = node.children;
				}

				if (node && node.type === 'file') return node;
				
				// JIKA GAGAL: Coba abaikan bagian pertama dari path (nama root)
				// Ini untuk menangani file zip yang dibuat ekstensi
				if (parts.length > 1) {
					parts = parts.slice(1); // Hapus "code_examples"
					currentLevel = rootChildren;
					node = null;
					for (const part of parts) {
						if (!currentLevel || !currentLevel[part]) {
							node = null;
							break;
						};
						node = currentLevel[part];
						currentLevel = node.children;
					}
				}

				return (node && node.type === 'file') ? node : null;
			};
			
			// [BARU] Helper untuk de-duplikasi
			const getMetadataScore = (data) => {
				if (data.value && data.value !== "#" && data.value !== "Dibuat otomatis dari komentar kode.") return 3;
				if (data.type && data.type !== "other") return 2;
				if (data.title) return 1;
				return 0;
			};

			window.Workspace = ({ project }) => {
				const [selectedFile, setSelectedFile] = useState(null);
				const [scrollToLine, setScrollToLine] = useState(null); 
				const [citations, setCitations] = useState([]);
				const [sources, setSources] = useState([]);

				// --- [HOOK LOGIKA GABUNGAN (JSON + KOMENTAR)] ---
				useEffect(() => {
					if (!project || !project.children) return;

					// Data dari JSON (Prioritas 1)
					const initialCitations = project.initialCitations || [];
					const initialSources = project.initialSources || [];
					
					// Map untuk de-duplikasi dan pencarian cepat
					const citationMap = new Map(); // "file.path-start-end"
					initialCitations.forEach(c => {
						citationMap.set(`${c.file}-${c.start}-${c.end}`, c);
					});
					
					const sourceTitleMap = new Map(); // "normalized_title"
					const finalSourcesMap = new Map(); // "id"
					
					initialSources.forEach(s => {
						const normalizedTitle = s.title.trim().toLowerCase();
						sourceTitleMap.set(normalizedTitle, s);
						finalSourcesMap.set(s.id, s);
					});


					// Data dari Komentar (Prioritas 2)
					const tempCitations = [];
					const sourceMetadataMap = new Map(); // "normalized_title" -> [data, data]

					// --- LANGKAH 1: Pindai komentar ---
					const traverseAndParse = (node, currentPath) => {
						if (!node) return;
						const nodeRelativePath = currentPath ? `${currentPath}/${node.name}` : node.name;

						if (node.type === "file") {
							const fileType = getFileType(node.name);
							if (fileType === "python" || fileType === "java") {
								const parsedItems = parseCitationsFromCode(node.content, fileType);

								parsedItems.forEach((item) => {
									const sourceData = item.sourceData;
									const normalizedTitle = sourceData.title.trim().toLowerCase();
									
									// Cek de-duplikasi JSON
									const citationKey = `${nodeRelativePath}-${item.start}-${item.end}`;
									if (citationMap.has(citationKey)) {
										return; // Sitasi ini sudah ada dari JSON, abaikan
									}

									// Kumpulkan sitasi komentar baru
									tempCitations.push({
										item: item,
										zipPath: nodeRelativePath,
										normalizedTitle: normalizedTitle,
									});

									// Kumpulkan metadata sumber
									if (!sourceMetadataMap.has(normalizedTitle)) {
										sourceMetadataMap.set(normalizedTitle, []);
									}
									sourceMetadataMap.get(normalizedTitle).push(sourceData);
								});
							}
						} else if (node.type === "folder" && node.children) {
							Object.values(node.children).forEach(child => traverseAndParse(child, nodeRelativePath));
						}
					};

					// Mulai pindai dari root (children)
					Object.values(project.children).forEach(child => traverseAndParse(child, ""));

					// --- LANGKAH 2: Gabungkan Sumber (Sources) ---
					let citationCounter = initialCitations.length;
					const sourceIdMap = new Map(); // Map<normalizedTitle, sourceId>
					
					sourceTitleMap.forEach((source, normalizedTitle) => {
						sourceIdMap.set(normalizedTitle, source.id);
					});

					sourceMetadataMap.forEach((dataList, normalizedTitle) => {
						// Jika sumber ini SUDAH ADA dari JSON, lewati (kita hanya de-duplikasi)
						if (sourceTitleMap.has(normalizedTitle)) {
							return; 
						}
						
						// Jika ini sumber BARU dari komentar, buat
						const bestData = dataList.sort((a, b) => getMetadataScore(b) - getMetadataScore(a))[0];

						let type = bestData.type;
						if (!type) {
							const valueOrTitle = bestData.value || bestData.title || "";
							if (valueOrTitle.match(/^https?:\/\//)) type = "url";
							else if (bestData.value) type = "other";
							else type = "other";
						}

						let value = bestData.value;
						if (!value) {
							if (type === "url" && (bestData.title || "").match(/^https?:\/\//)) {
								value = bestData.title;
							} else if (type === "url") {
								value = "#";
							} else {
								value = "Dibuat otomatis dari komentar kode.";
							}
						}

						const sourceId = `auto-source-${Date.now()}-${citationCounter++}`;
						const newSource = {
							id: sourceId,
							title: bestData.title,
							type: type,
							value: value,
						};
						
						finalSourcesMap.set(sourceId, newSource);
						sourceIdMap.set(normalizedTitle, sourceId);
					});
					
					// --- LANGKAH 3: Gabungkan Sitasi (Citations) ---
					const newCitations = [];
					tempCitations.forEach((tempCite) => {
						const sourceId = sourceIdMap.get(tempCite.normalizedTitle);
						if (!sourceId) return; 

						newCitations.push({
							id: `auto-cite-${Date.now()}-${citationCounter++}`,
							file: tempCite.zipPath,
							start: tempCite.item.start,
							end: tempCite.item.end,
							code: tempCite.item.code,
							note: tempCite.item.sourceData.notes || "Sitasi ini dibuat otomatis dari komentar kode.",
							sourceId: sourceId,
							color: COLORS[citationCounter % COLORS.length],
							isEditing: false, 
						});
					});

					// --- LANGKAH 4: Set State ---
					// Kita perlu memberi 'color' dan 'isEditing' pada sitasi awal
					const finalInitialCitations = initialCitations.map((c, i) => ({
						...c,
						color: COLORS[i % COLORS.length],
						isEditing: false,
					}));
					
					setSources(Array.from(finalSourcesMap.values()));
					setCitations([...finalInitialCitations, ...newCitations]);

				}, [project]);
				// --- [AKHIR HOOK LOGIKA GABUNGAN] ---

				const handleAddCitation = (citationData) => {
					// Cek duplikasi sebelum menambahkan form baru
					const isDuplicate = citations.some(
						(c) =>
							c.file === citationData.file &&
							!c.isEditing && // Abaikan sitasi lain yang sedang diedit
							Math.max(c.start, citationData.start) <= Math.min(c.end, citationData.end)
					);
					if (isDuplicate) {
						console.error("Sebagian atau seluruh baris ini sudah disitasi.");
						return;
					}

					const newCitation = {
						id: "cite-" + Date.now(),
						...citationData,
						note: "",
						sourceId: null,
						color: COLORS[citations.length % COLORS.length],
						isEditing: true, // Mulai dalam mode edit
					};
					setCitations((prev) => [...prev, newCitation]);
				};

				const handleDeleteCitation = (citationId) => {
					setCitations((prev) => prev.filter((c) => c.id !== citationId));
				};

				const handleToggleEdit = (citationId) => {
					setCitations((prev) => prev.map((c) => (c.id === citationId ? { ...c, isEditing: true } : c)));
				};

				const handleCancelEdit = (citationId) => {
					const citation = citations.find((c) => c.id === citationId);
					// Jika sitasi belum punya sourceId, berarti ini sitasi baru yg dibatalkan, jadi hapus saja.
					if (!citation.sourceId) {
						handleDeleteCitation(citationId);
					} else {
						// Jika sudah ada, kembalikan ke mode display
						setCitations((prev) => prev.map((c) => (c.id === citationId ? { ...c, isEditing: false } : c)));
					}
				};

				const handleSaveCitation = (citationId, saveData) => {
					let newSourceId = saveData.selectedSource;
					let updatedSources = [...sources];

					if (saveData.selectedSource === "new") {
						const newSource = {
							id: "source-" + Date.now(),
							title: saveData.newSourceTitle,
							type: saveData.newSourceType,
							value: saveData.newSourceValue,
						};
						updatedSources.push(newSource);
						setSources(updatedSources);
						newSourceId = newSource.id;
					}

					const updatedCitations = citations.map((c) => {
						if (c.id === citationId) {
							return {
								...c,
								sourceId: newSourceId,
								note: saveData.note,
								isEditing: false, // Keluar dari mode edit
							};
						}
						return c;
					});
					setCitations(updatedCitations);
				};

				// --- [REVISI] handleExport sekarang akan menghapus JSON lama ---
				const handleExport = async () => {
					if (!project.originalFile) {
						console.error("File zip asli tidak tersedia.");
						return;
					}
					
					// Data baru untuk diekspor
					const dataToExport = {
						sources: sources,
						citations: citations.map(({ isEditing, color, ...rest }) => rest), // Hapus data UI
					};
					const jsonString = JSON.stringify(dataToExport, null, 2);

					try {
						// Muat file zip ASLI yang diunggah
						const zip = await JSZip.loadAsync(project.originalFile);

						// [REVISI] Cari dan hapus file .codesite.json LAMA
						// Kita asumsikan nama file JSON sama dengan nama proyek
						const jsonFileName = `${project.name}.codesite.json`;
						
						// Cek di root (format website)
						if (zip.files[jsonFileName]) {
							zip.remove(jsonFileName);
						}
						
						// Cek di dalam folder (format ekstensi lama, jaga-jaga)
						const oldJsonPath = `${project.name}/${project.name}.codesite.json`;
						if (zip.files[oldJsonPath]) {
							zip.remove(oldJsonPath);
						}

						// Tambahkan file metadata BARU ke root zip
						zip.file(jsonFileName, jsonString);

						// Generate file zip BARU
						const newZipBlob = await zip.generateAsync({ type: "blob" });

						// Buat nama file unik dengan timestamp
						const now = new Date();
						const pad = (num) => String(num).padStart(2, "0");
						const timestamp = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}-${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
						const newFilename = `${project.name}-codecite-${timestamp}.zip`;

						// Memicu unduhan
						const link = document.createElement("a");
						link.href = URL.createObjectURL(newZipBlob);
						link.download = newFilename;
						document.body.appendChild(link);
						link.click();
						document.body.removeChild(link);
						URL.revokeObjectURL(link.href);
					} catch (error) {
						console.error("Gagal memproses atau membuat file zip:", error);
					}
				};
				// --- [AKHIR REVISI handleExport] ---

				const handleJumpToCitation = (citation) => {
					if (!citation || !citation.file || !project.children) return;

					// Cari node file berdasarkan path lengkap
					const fileNode = findFileNodeByPath(project.children, citation.file);
					
					if (fileNode) {
						setSelectedFile(fileNode);
						setScrollToLine(citation.start);
					} else {
						console.error(`File node not found for path: ${citation.file}`);
					}
				};

				return React.createElement(
					"div",
					{ className: "bg-white p-4 rounded-lg shadow-lg h-[80vh] flex flex-col" },
					React.createElement("h2", { className: "text-xl font-bold text-gray-800 mb-4" }, "Proyek: " + project.name),
					React.createElement(
						"div",
						{ className: "grid grid-cols-1 md:grid-cols-12 gap-4 flex-1 h-[70vh]" },

						// File Explorer
						React.createElement(
							"div",
							{
								className: "col-span-12 md:col-span-3 bg-gray-100 rounded-md flex flex-col h-full overflow-y-auto",
							},
							React.createElement("h3", { className: "font-semibold p-2 sticky top-0 bg-gray-100 z-10" }, "File Explorer"),
							React.createElement(
								"div",
								{ className: "p-2" },
								React.createElement(window.FileExplorer, {
									node: project,
									onSelectFile: setSelectedFile,
								})
							)
						),

						// Code Editor
						React.createElement(window.CodeEditor, {
							file: selectedFile,
							onAddCitation: handleAddCitation,
							citations: citations, // Kirim SEMUA sitasi
							scrollToLine: scrollToLine, 
							onScrollDone: () => setScrollToLine(null), 
						}),

						// Citation Panel
						React.createElement(
							"div",
							{
								className: "col-span-12 md:col-span-3 bg-gray-100 rounded-md flex flex-col h-full overflow-hidden",
							},

							// Header
							React.createElement(
								"div",
								{
									className: "flex justify-between items-center p-2 sticky top-0 bg-gray-100 z-10",
								},
								React.createElement("h3", { className: "font-semibold" }, "Panel Sitasi"),
								React.createElement(
									"button",
									{
										onClick: handleExport,
										className: "text-xs bg-blue-500 text-white px-2 py-1 rounded hover:bg-blue-600",
									},
									"Export Code Cite"
								)
							),

							// Info text
							React.createElement("div", { className: "text-sm text-gray-600 mb-2 px-2" }, "Klik dan drag pada kode untuk menambahkan sitasi."),

							// Scrollable list
							React.createElement(
								"div",
								{ className: "flex-1 overflow-y-auto px-2 pb-2" },
								React.createElement(
									"ul",
									{ className: "space-y-3" },
									citations.map((c) =>
										React.createElement(window.CitationItem, {
											key: c.id,
											citation: c,
											source: sources.find((s) => s.id === c.sourceId),
											allSources: sources,
											onSave: handleSaveCitation,
											onCancel: handleCancelEdit,
											onDelete: handleDeleteCitation,
											onEdit: handleToggleEdit,
											onJumpTo: handleJumpToCitation, 
										})
									)
								)
							)
						)
					)
				);
			};
			//==================================================
			// Component: Workspace End
			//==================================================

			//==================================================
			// Component: File Explorer
			//==================================================
			window.FileExplorer = ({ node, onSelectFile }) => {
				const [expanded, setExpanded] = useState(true);

				if (node.type === "file") {
					return React.createElement(
						"div",
						{
							className: "pl-4 py-1 cursor-pointer hover:bg-gray-200 rounded",
							onClick: () => onSelectFile(node),
						},
						`ðŸ“„ ${node.name}`
					);
				}

				return React.createElement(
					"div",
					{ className: "pl-2" },
					React.createElement(
						"div",
						{
							className: "font-semibold cursor-pointer flex items-center hover:bg-gray-200 rounded px-1",
							onClick: () => setExpanded(!expanded),
						},
						`${expanded ? "ðŸ“‚" : "ðŸ“"} ${node.name}`
					),

					expanded &&
						React.createElement(
							"div",
							{ className: "pl-4" },
							Object.values(node.children).map((child) =>
								React.createElement(FileExplorer, {
									key: child.name,
									node: child,
									onSelectFile: onSelectFile,
								})
							)
						)
				);
			};

			//==================================================
			// Component: File Explorer End
			//==================================================

			//==================================================
			// Component: Code Editor
			//==================================================
			window.CodeEditor = ({ file, onAddCitation, citations, scrollToLine, onScrollDone }) => {
				const [lines, setLines] = useState([]);
				const [dragStart, setDragStart] = useState(null);
				const [dragEnd, setDragEnd] = useState(null);
				const [isDragging, setIsDragging] = useState(false);

				const editorRef = useRef(null);
				const rafRef = useRef(null);
				const lastMouseEventRef = useRef(null);

				// Refs untuk data supaya handler global bisa mengakses nilai terbaru
				const linesRef = useRef([]);
				const dragStartRef = useRef(null);
				const dragEndRef = useRef(null);
				const isDraggingRef = useRef(false);
				const onAddCitationRef = useRef(onAddCitation);

				useEffect(() => {
					onAddCitationRef.current = onAddCitation;
				}, [onAddCitation]);

				useEffect(() => {
					linesRef.current = lines;
				}, [lines]);

				useEffect(() => {
					dragStartRef.current = dragStart;
				}, [dragStart]);

				useEffect(() => {
					dragEndRef.current = dragEnd;
				}, [dragEnd]);

				useEffect(() => {
					isDraggingRef.current = isDragging;
				}, [isDragging]);

				// --- [EFEK BARU] UNTUK AUTO-SCROLL ---
				useEffect(() => {
					if (scrollToLine && editorRef.current && lines.length > 0) {
						// Cari elemen barisnya
						const lineElement = editorRef.current.querySelector(`[data-line="${scrollToLine}"]`);
						
						if (lineElement) {
							// Lakukan scroll
							lineElement.scrollIntoView({
								behavior: "smooth",
								block: "center", // Posisikan di tengah layar
							});

							// Tambahkan efek highlight "flash"
							lineElement.classList.add("flash-highlight");
							setTimeout(() => {
								if (lineElement) {
									lineElement.classList.remove("flash-highlight");
								}
							}, 1500); // Durasi flash 1.5 detik
						}
						
						// Beri tahu parent bahwa scroll sudah selesai (atau setidaknya sudah di-trigger)
						onScrollDone();
					}
				}, [scrollToLine, file, lines]); // Bergantung pada scrollToLine, file, dan render 'lines'
				// --- [AKHIR EFEK BARU] ---


				const handleGlobalMouseUp = (e) => {
					if (isDraggingRef.current && dragStartRef.current != null && dragEndRef.current != null) {
						const start = Math.min(dragStartRef.current, dragEndRef.current);
						const end = Math.max(dragStartRef.current, dragEndRef.current);
						
						const codeBlock = linesRef.current.slice(start - 1, end).join("\n");
						if (onAddCitationRef.current) {
							onAddCitationRef.current({
								file: file.path, // <-- Gunakan file.path
								start,
								end,
								code: codeBlock,
							});
						}
					}
					resetDrag();
				};

				// Gunakan useRef untuk menyimpan referensi stabil ke handleGlobalMouseUp
				const globalMouseUpHandlerRef = useRef(handleGlobalMouseUp);
				useEffect(() => {
					globalMouseUpHandlerRef.current = handleGlobalMouseUp;
				}, [file, lines]); // Update jika dependensi berubah

				const resetDrag = () => {
					setDragStart(null);
					setDragEnd(null);
					setIsDragging(false);
					window.removeEventListener("mouseup", globalMouseUpHandlerRef.current);
				};

				useEffect(() => {
					if (file) {
						setLines(file.content.split("\n"));
						resetDrag();
					} else {
						setLines([]);
					}
					return () => {
						if (rafRef.current) cancelAnimationFrame(rafRef.current);
						window.removeEventListener("mouseup", globalMouseUpHandlerRef.current);
					};
				}, [file]);

				const handleMouseDown = (lineNumber) => {
					setDragStart(lineNumber);
					setDragEnd(lineNumber);
					setIsDragging(true);
					window.addEventListener("mouseup", globalMouseUpHandlerRef.current);
				};

				const handleMouseEnter = (lineNumber) => {
					if (isDragging) {
						setDragEnd(lineNumber);
					}
				};

				const updateDragEndFromPoint = (clientX, clientY) => {
					const editor = editorRef.current;
					if (!editor) return;

					let el = document.elementFromPoint(clientX, clientY);
					if (el) {
						const lineEl = el.closest(".code-line");
						if (lineEl && lineEl.dataset && lineEl.dataset.line) {
							const ln = Number(lineEl.dataset.line);
							setDragEnd(ln);
							return;
						}
					}
				};

				const handleMouseMove = (e) => {
					if (!isDragging) return;
					lastMouseEventRef.current = e;
					if (rafRef.current) return;

					rafRef.current = requestAnimationFrame(() => {
						rafRef.current = null;
						const ev = lastMouseEventRef.current;
						if (!ev || !editorRef.current) return;

						const rect = editorRef.current.getBoundingClientRect();
						const zone = 60;
						const maxSpeed = 35;
						const speedFactor = 3.5;
						const topEdge = rect.top + zone;
						const bottomEdge = rect.bottom - zone;

						if (ev.clientY < topEdge) {
							const distance = Math.max(1, topEdge - ev.clientY);
							const speed = Math.min(maxSpeed, distance / speedFactor);
							editorRef.current.scrollTop -= speed;
						} else if (ev.clientY > bottomEdge) {
							const distance = Math.max(1, ev.clientY - bottomEdge);
							const speed = Math.min(maxSpeed, distance / speedFactor);
							editorRef.current.scrollTop += speed;
						}
						updateDragEndFromPoint(ev.clientX, ev.clientY);
					});
				};

				const handleMouseUp = (e) => {
					globalMouseUpHandlerRef.current(e);
				};

				// --- [FUNGSI DIPERBARUI DENGAN LOGIKA PRIORITAS] ---
				const getHighlightColor = (lineNumber) => {
					if (!file) return "";

					// 1. PRIORITAS TERTINGGI: Cek sitasi yang sedang di-edit
					const editingCitation = citations.find(
						(c) => c.file === file.path && c.isEditing && lineNumber >= c.start && lineNumber <= c.end
					);
					if (editingCitation) {
						return "bg-yellow-500/50"; // <-- Warna highlight SEMENTARA
					}

					// 2. PRIORITAS KEDUA: Cek sitasi yang sudah disimpan
					//    Kita cari dari belakang (reverse) agar sitasi terbaru tampil di atas
					const savedCitation = citations
						.slice()
						.reverse()
						.find((c) => c.file === file.path && !c.isEditing && lineNumber >= c.start && lineNumber <= c.end);
					if (savedCitation) {
						return savedCitation.color; // <-- Warna highlight PERMANEN
					}

					// 3. PRIORITAS KETIGA: Highlight untuk *dragging* manual (sebelum mouse up)
					if (isDragging && dragStart != null && dragEnd != null) {
						const start = Math.min(dragStart, dragEnd);
						const end = Math.max(dragStart, dragEnd);
						if (lineNumber >= start && lineNumber <= end) {
							return "bg-cyan-900/40";
						}
					}

					// 4. Tidak ada highlight
					return "";
				};
				// --- [AKHIR FUNGSI DIPERBARUI] ---

				if (!file) {
					return React.createElement("div", { className: "col-span-12 md:col-span-6 bg-[#282c34] rounded-md flex flex-col h-full overflow-y-auto items-center justify-center text-gray-400" }, "Pilih file untuk ditampilkan");
				}

				return React.createElement(
					"div",
					{
						className: "col-span-12 md:col-span-6 bg-[#282c34] rounded-md flex flex-col h-full overflow-hidden font-mono text-sm select-none",
						onMouseUp: handleMouseUp,
						onMouseMove: handleMouseMove,
					},
					React.createElement("div", { className: "bg-gray-700 text-white p-2 rounded-t-md flex-shrink-0" }, file.path), // <-- Tampilkan path
					React.createElement(
						"div",
						{
							ref: editorRef,
							className: "flex-1 overflow-auto text-gray-200",
						},
						lines.map((line, i) => {
							const lineNumber = i + 1;
							const highlightClass = getHighlightColor(lineNumber) || "hover:bg-gray-700/50";
							return React.createElement(
								"div",
								{
									key: i,
									"data-line": lineNumber,
									className: `code-line flex group cursor-pointer ${highlightClass}`,
									onMouseDown: () => handleMouseDown(lineNumber),
									onMouseEnter: () => handleMouseEnter(lineNumber),
								},
								React.createElement("div", { className: "w-12 text-right pr-4 text-gray-500 select-none sticky left-0 bg-[#282c34]" }, lineNumber),
								React.createElement(
									"pre",
									{ className: "flex-1 whitespace-pre-wrap py-0 px-2" },
									React.createElement("code", {
										dangerouslySetInnerHTML: {
											__html: hljs.highlight(line, { language: file.name.split(".").pop(), ignoreIllegals: true }).value,
										},
									})
								)
							);
						})
					)
				);
			};

			//==================================================
			// Component: Code Editor End
			//==================================================

			//==================================================
			// Component: Citetation Item
			//==================================================
			window.CitationItem = ({ citation, source, allSources, onSave, onCancel, onDelete, onEdit, onJumpTo }) => {
				// State untuk form di dalam item ini
				const [selectedSource, setSelectedSource] = useState("new");
				const [newSourceTitle, setNewSourceTitle] = useState("");
				const [newSourceType, setNewSourceType] = useState("url");
				const [newSourceValue, setNewSourceValue] = useState("");
				const [note, setNote] = useState(citation.note || "");

				// useEffect untuk me-reset form state saat mode edit diaktifkan
				useEffect(() => {
					if (citation.isEditing) {
						// Jika sitasi sudah punya sumber, set dropdown ke sumber tsb
						if (citation.sourceId) {
							setSelectedSource(citation.sourceId);
						} else {
							setSelectedSource("new");
						}
						setNote(citation.note || "");
						// Reset form 'new source'
						setNewSourceTitle("");
						setNewSourceType("url");
						setNewSourceValue("");

						// Jika sitasi dibuat otomatis DAN belum diedit manual,
						// coba isi form 'new source' dari data sitasi.
						if (citation.id.startsWith("auto-cite-") && source) {
							// Jika ini sitasi otomatis, kita ingin pengguna
							// mengonfirmasi/mengedit sumber yang dibuat otomatis.
							// Kita set dropdown ke 'new' dan isi field-nya.
							setSelectedSource("new");
							setNewSourceTitle(source.title);
							setNewSourceType(source.type);
							setNewSourceValue(source.value);
						}
					}
				}, [citation.isEditing, citation.sourceId, citation.note, allSources, source]);

				const handleSaveClick = () => {
					// Validasi: Judul wajib diisi jika membuat sumber baru
					if (selectedSource === "new" && !newSourceTitle.trim()) {
						// Di aplikasi nyata, gunakan UI non-blocking, bukan alert.
						console.error("Judul referensi wajib diisi saat membuat sumber baru.");
						return;
					}

					// Cek apakah ini sitasi otomatis yang sedang diedit
					const isAutoCitationEdit = citation.id.startsWith("auto-cite-");

					onSave(citation.id, {
						selectedSource,
						newSourceTitle,
						newSourceType,
						newSourceValue,
						note,
						// Jika ini edit pertama dari sitasi otomatis, kita mungkin
						// ingin menghapus sumber otomatis lamanya jika tidak ada
						// sitasi lain yang menggunakannya.
						// (Logika ini bisa ditambahkan di 'handleSaveCitation' di Workspace)
					});
				};

				// Tampilan Mode Edit
				if (citation.isEditing) {
					return React.createElement(
						"li",
						{ className: "bg-white shadow-md p-3 rounded-lg border text-xs space-y-2" },
						// Dropdown Pemilihan Sumber
						React.createElement(
							"div",
							null,
							React.createElement("label", { className: "block font-medium mb-1" }, "Sumber Referensi"),
							React.createElement(
								"select",
								{
									value: selectedSource,
									onChange: (e) => setSelectedSource(e.target.value),
									className: "w-full border p-1 rounded",
								},
								React.createElement("option", { value: "new" }, "--- Buat / Edit Sumber ---"),
								// Filter 'allSources' agar tidak menampilkan sumber otomatis
								// yang terkait DENGAN sitasi ini (jika ada)
								allSources
									.filter((s) => s.id !== citation.sourceId || !citation.id.startsWith("auto-cite-"))
									.map((s) => React.createElement("option", { key: s.id, value: s.id }, s.title))
							)
						),

						// Form untuk Sumber Baru (muncul kondisional)
						selectedSource === "new" &&
							React.createElement(
								"div",
								{ className: "border p-2 rounded space-y-2 bg-gray-50" },
								React.createElement("input", {
									type: "text",
									placeholder: "Judul / ID Referensi (e.g., Gemini, StackOverflow)",
									value: newSourceTitle,
									onChange: (e) => setNewSourceTitle(e.target.value),
									className: "w-full border p-1 rounded",
								}),
								React.createElement(
									"select",
									{
										value: newSourceType,
										onChange: (e) => setNewSourceType(e.target.value),
										className: "w-full border p-1 rounded",
									},
									React.createElement("option", { value: "url" }, "Link / URL"),
									React.createElement("option", { value: "ai" }, "AI (Kecerdasan Buatan)"),
									React.createElement("option", { value: "other" }, "Lainnya (Teks)")
								),
								newSourceType === "url" &&
									React.createElement("input", { type: "text", placeholder: "https://example.com", value: newSourceValue, onChange: (e) => setNewSourceValue(e.target.value), className: "w-full border p-1 rounded" }),
								newSourceType === "ai" &&
									React.createElement("input", { type: "text", placeholder: "e.g., ChatGPT 4, Gemini", value: newSourceValue, onChange: (e) => setNewSourceValue(e.target.value), className: "w-full border p-1 rounded" }),
								newSourceType === "other" &&
									React.createElement("textarea", { placeholder: "e.g., Bantuan dari teman, kode dari tugas lama", value: newSourceValue, onChange: (e) => setNewSourceValue(e.target.value), className: "w-full border p-1 rounded", rows: 2 })
							),

						// Kolom Catatan
						React.createElement(
							"div",
							null,
							React.createElement("label", { className: "block font-medium mb-1" }, "Catatan (Notes)"),
							React.createElement("textarea", {
								value: note,
								onChange: (e) => setNote(e.target.value),
								placeholder: "Tambahkan detail, misal: prompt yang digunakan...",
								className: "w-full border p-1 rounded text-gray-700",
								rows: 3,
							})
						),

						// Tombol Aksi
						React.createElement(
							"div",
							{ className: "flex justify-end space-x-2 pt-2" },
							React.createElement("button", { onClick: () => onCancel(citation.id), className: "bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded" }, "Batal"),
							React.createElement("button", { onClick: handleSaveClick, className: "bg-cyan-600 text-white hover:bg-cyan-700 px-3 py-1 rounded" }, "Simpan")
						)
					);
				}

				// Tampilan Mode Normal (Display)
				return React.createElement(
					"li",
					{
						key: citation.id,
						className: "bg-white shadow-sm p-3 rounded-md border text-xs space-y-1",
					},
					React.createElement(
						"div",
						{ className: "flex justify-between items-start" },
						React.createElement(
							"div",
							null,
							React.createElement("strong", { className: "text-sm" }, source ? source.title : React.createElement("span", { className: "text-red-500" }, "Sumber belum diatur")),
							React.createElement("div", { className: "text-gray-500 text-[11px]" }, `(${source ? source.type : "N/A"})`)
						),
						React.createElement(
							"div",
							{ className: "flex space-x-2" },
							React.createElement("button", { onClick: () => onEdit(citation.id), className: "text-xs font-medium text-blue-700 bg-blue-100 hover:bg-blue-200 border border-blue-300 rounded-md px-2 py-0.5" }, "Ubah"),
							React.createElement("button", { onClick: () => onDelete(citation.id), className: "text-xs font-medium text-red-700 bg-red-100 hover:bg-red-200 border border-red-300 rounded-md px-2 py-0.5" }, "Hapus")
						)
					),
					// [PERUBAHAN]: Teks ini sekarang clickable
					React.createElement(
						"div",
						{
							className: "text-gray-600 font-semibold cursor-pointer hover:text-cyan-600 hover:underline",
							onClick: () => onJumpTo(citation), // <-- AKSI BARU
						},
						`${citation.file} (Baris ${citation.start}${citation.end !== citation.start ? `â€“${citation.end}` : ""})`
					),
					React.createElement("pre", { className: "bg-gray-100 p-1.5 rounded mt-1 overflow-x-auto text-[11px]" }, React.createElement("code", null, citation.code)),
					citation.note && React.createElement("div", { className: "mt-1 pt-1 border-t" }, React.createElement("p", { className: "whitespace-pre-wrap" }, citation.note))
				);
			};

			//==================================================
			// Component: Citetation Item End
			//==================================================

			//==================================================
			// Component: App
			//==================================================
			const App = () => {
				const [project, setProject] = useState(null);

				// [REVISI] buildFileTree sekarang menyimpan path lengkap di node
				const buildFileTree = async (files, onJsonFound) => {
					const root = {};
					
					// [REVISI] Cari file JSON terlebih dahulu
					const jsonFileEntry = Object.entries(files).find(([relativePath, file]) => 
						!file.dir && relativePath.endsWith('.codesite.json')
					);
					
					if (jsonFileEntry) {
						const [relativePath, jsonFile] = jsonFileEntry;
						try {
							const jsonContent = await jsonFile.async("string");
							const parsedData = JSON.parse(jsonContent);
							onJsonFound(parsedData);
						} catch (err) {
							console.error("Gagal mem-parsing file .codesite.json:", err);
						}
					}

					// Sekarang bangun file tree untuk file-file lainnya
					for (const relativePath in files) {
						const file = files[relativePath];
						if (file.dir || relativePath.endsWith('.codesite.json')) continue; // Lewati folder & file json

						const parts = relativePath.split("/").filter((p) => p);
						let current = root;

						for (let i = 0; i < parts.length; i++) {
							const part = parts[i];
							const isFile = i === parts.length - 1;
							const currentPath = parts.slice(0, i + 1).join('/');

							if (isFile) {
								const content = await files[relativePath].async("string");
								current[part] = { 
									name: part, 
									path: currentPath, // <-- Simpan path lengkap
									type: "file", 
									content 
								};
							} else {
								current[part] = current[part] || { 
									name: part, 
									path: currentPath, // <-- Simpan path lengkap
									type: "folder", 
									children: {} 
								};
								current = current[part].children;
							}
						}
					}
					return root;
				};

				// [REVISI] handleUpload sekarang menangani impor JSON
				const handleUpload = async (file, projectName) => {
					try {
						const zip = await JSZip.loadAsync(file);
						
						let initialData = { sources: [], citations: [] };
						
						// Fungsi callback untuk mengambil data JSON
						const onJsonFound = (parsedData) => {
							initialData.sources = parsedData.sources || [];
							initialData.citations = parsedData.citations || [];
						};

						// buildFileTree sekarang akan mencari JSON DAN membangun tree
						const fileTree = await buildFileTree(zip.files, onJsonFound);

						setProject({
							name: projectName,
							children: fileTree,
							type: "folder",
							originalFile: file,
							initialSources: initialData.sources,
							initialCitations: initialData.citations,
						});
					} catch (error) {
						console.error("Gagal memproses file zip:", error);
					}
				};

				return (
					// Mengubah div terluar menjadi flex container dengan tinggi seukuran layar
					React.createElement(
						"div",
						{ className: "flex flex-col h-screen bg-gray-100" },
						React.createElement(window.Header),
						React.createElement(window.Navbar),
						// "main" akan mengisi sisa ruang yang tersedia dan menangani overflow internal
						React.createElement(
							"main",
							{ className: "px-6 py-6 flex-1 overflow-hidden" },
							!project
								? React.createElement(window.UploadScreen, { onUpload: handleUpload })
								: // Workspace sekarang akan mengisi area 'main' ini sepenuhnya
								  React.createElement(window.Workspace, { project: project })
						)
					)
				);
			};

			ReactDOM.render(React.createElement(App), document.getElementById("root"));

			//==================================================
			// Component: App End
			//==================================================
		</script>
	</body>
</html>